<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Space Fleet</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { background:#0b1020; color:white; font-family:Arial; text-align:center }
.card { background:#151b35; margin:15px; padding:15px; border-radius:12px }
button { padding:10px 20px; margin:5px; font-size:16px }
</style>
</head>
<body>

<h2>üöÄ Space Fleet</h2>

<div class="card">
  <b>–ú–æ–∏ —Ä–∞–∫–µ—Ç—ã</b><br>
  <div id="myRockets">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="card">
  <b>–ö—É–ø–∏—Ç—å —Ä–∞–∫–µ—Ç—ã</b><br>
  <button onclick="buyRocket('Scout')">Scout (10‚≠ê)</button>
  <button onclick="buyRocket('Cargo')">Cargo (25‚≠ê)</button>
  <button onclick="buyRocket('Fighter')">Fighter (50‚≠ê)</button>
  <button onclick="buyRocket('Explorer')">Explorer (100‚≠ê)</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const API = "https://script.google.com/macros/s/AKfycbw6g9E1qQ69FEWjHjFsPzRhbafMSf57SnoUwBcxPpJccicP9g4TD9N0Q9T7hB2x7GZbkw/exec";

// ===== –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è user.id =====
function waitForUserId(callback) {
  const interval = setInterval(() => {
    if (tg.initDataUnsafe?.user?.id) {
      clearInterval(interval);
      callback(tg.initDataUnsafe.user.id);
    }
  }, 100);
}

waitForUserId(userId => {
  console.log("USER ID:", userId);
  loadRockets(userId);

  // ===== –ü–æ–∫—É–ø–∫–∞ —Ä–∞–∫–µ—Ç—ã =====
  window.buyRocket = function(type) {
    tg.sendData(JSON.stringify({
      action: "buy_rocket",
      type: type
    }));
  };

  // ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –æ–ø–ª–∞—Ç—ã =====
  tg.onEvent("visibility_changed", () => {
    if (tg.isVisible) loadRockets(userId);
  });
});

// ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∫–µ—Ç =====
function loadRockets(userId) {
  const el = document.getElementById("myRockets");
  fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "getRockets",
      user_id: userId
    })
  })
  .then(r => r.json())
  .then(list => {
    if (!Array.isArray(list) || list.length === 0) {
      el.innerText = "–ù–µ—Ç —Ä–∞–∫–µ—Ç";
      return;
    }
    el.innerHTML = list.map(r => "üöÄ " + r.type).join("<br>");
  })
  .catch(err => {
    console.error(err);
    el.innerText = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
  });
}
</script>

</body>
</html>
