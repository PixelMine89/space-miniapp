<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Space Fleet</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { background:#0b1020; color:white; font-family:Arial; text-align:center }
.card { background:#151b35; margin:15px; padding:15px; border-radius:12px }
button { padding:10px 20px; margin:5px; font-size:16px }
</style>
</head>
<body>

<h2>üöÄ Space Fleet</h2>

<div class="card">
  <b>–ú–æ–∏ —Ä–∞–∫–µ—Ç—ã</b><br>
  <div id="myRockets">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="card">
  <b>–ö—É–ø–∏—Ç—å</b><br>
  <button onclick="buy('Scout')">Scout (1‚≠ê)</button>
  <button onclick="buy('Cargo')">Cargo (25‚≠ê)</button>
  <button onclick="buy('Fighter')">Fighter (50‚≠ê)</button>
  <button onclick="buy('Explorer')">Explorer (100‚≠ê)</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

const rocketsDiv = document.getElementById("myRockets");
const API = "https://script.google.com/macros/s/AKfycbzy4T5ypktbQpAkzWoNmU_nPmZDsKTgQ6n3C2-d7IgHL0GXHjlaLtBp_2OhD_zE-h68ZA/exec";

let USER_ID = null;

// ===== DEBUG (–ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –û–¢–†–ê–ë–û–¢–ê–ï–¢) =====
setTimeout(() => {
  alert(
    "DEBUG\n" +
    "initData: " + tg.initData + "\n\n" +
    "initDataUnsafe: " + JSON.stringify(tg.initDataUnsafe)
  );
}, 500);

// ===== –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ user_id =====
function initUser() {
  const user = tg.initDataUnsafe?.user;

  if (!user?.id) {
    rocketsDiv.innerText = "‚ùå user_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω";
    return;
  }

  USER_ID = user.id;
  loadRockets();
}

function loadRockets() {
  rocketsDiv.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

  fetch(${API}?action=getRockets&user_id=${USER_ID})
    .then(r => r.json())
    .then(list => {
      if (!Array.isArray(list) || list.length === 0) {
        rocketsDiv.innerText = "–ù–µ—Ç —Ä–∞–∫–µ—Ç";
        return;
      }
      rocketsDiv.innerHTML = list.map(r => "üöÄ " + r.type).join("<br>");
    })
    .catch(err => {
      rocketsDiv.innerText = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    });
}

// ===== –ø–æ–∫—É–ø–∫–∞ –ù–ï –¢–†–û–ì–ê–ï–ú =====
function buy(type) {
  tg.sendData(JSON.stringify({
    action: "buy_rocket",
    type
  }));
}

tg.onEvent("visibility_changed", () => {
  if (tg.isVisible && USER_ID) {
    loadRockets();
  }
});

initUser();
</script>
</body>
</html>


