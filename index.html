<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Space Fleet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background:#0b1020; color:white; font-family:Arial; text-align:center }
    .card { background:#151b35; margin:15px; padding:15px; border-radius:12px }
    button { padding:10px 20px; margin:5px; font-size:16px }
  </style>
</head>
<body>

<h2>üöÄ Space Fleet</h2>

<div class="card">
  ‚≠ê Stars: <span id="stars">0</span><br>
  üí∞ Credits: <span id="credits">0</span>
</div>

<div class="card">
  <b>–ö—É–ø–∏—Ç—å ‚≠ê</b><br>
  <button onclick="buyStars(10)">10 ‚≠ê</button>
  <button onclick="buyStars(25)">25 ‚≠ê</button>
  <button onclick="buyStars(50)">50 ‚≠ê</button>
</div>

<div class="card">
  <b>–†–∞–∫–µ—Ç—ã</b><br>
  <button onclick="buyRocket('Scout')">Scout (10‚≠ê)</button>
  <button onclick="buyRocket('Cargo')">Cargo (25‚≠ê)</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const API_URL = "https://script.google.com/macros/s/AKfycbzkrq92foo79pcOF04ijFsj6o5VUcjlnTcpbgbWgDB1WyZ2hgg6q7nyOqrxOWqhrJ-Y9A/exec";
const userId = tg.initDataUnsafe.user.id;

// register
fetch(API_URL, {
  method: "POST",
  body: JSON.stringify({ action: "register", user_id: userId })
}).then(loadUser);

function loadUser() {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getUser", user_id: userId })
  })
  .then(r => r.json())
  .then(u => {
    document.getElementById("stars").innerText = u.stars || 0;
    document.getElementById("credits").innerText = u.credits || 0;
  });
}

function buyRocket(type) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ action: "buyRocket", user_id: userId, type })
  })
  .then(r => r.json())
  .then(res => {
    alert(JSON.stringify(res));
    loadUser();
  });
}

function buyStars(amount) {
  tg.openInvoice({
    title: "–ü–æ–∫—É–ø–∫–∞ –∑–≤–µ–∑–¥",
    description: amount + " ‚≠ê",
    payload: "stars_" + amount,
    currency: "XTR",
    prices: [{ label: amount + " ‚≠ê", amount }]
  });
}

tg.onEvent("invoiceClosed", e => {
  if (e.status === "paid") {
    const amount = Number(e.payload.split("_")[1]);
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: "addStars", user_id: userId, amount })
    }).then(loadUser);
  }
});
</script>

</body>
</html>
