<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Space Fleet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; font-family: Arial; background: #0b1020; color: #fff; text-align:center; }
    h1 { margin-top: 20px; }
    .card { background:#151b35; margin:15px; padding:15px; border-radius:12px; }
    button { background:#4da3ff; border:none; padding:12px 20px; border-radius:10px; font-size:16px; cursor:pointer; margin-top:10px; }
  </style>
</head>
<body>

<h1>üöÄ Space Fleet</h1>

<div class="card">
  <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π —Å–∏–º—É–ª—è—Ç–æ—Ä.</p>
  <p>–£–ø—Ä–∞–≤–ª—è–π —Ä–∞–∫–µ—Ç–∞–º–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∫–æ–π.</p>
</div>

<div class="card">
  <p><b>Credits:</b> <span id="credits">0</span></p>
</div>

<div class="card">
  <button onclick="addCredits(10)">–ü–æ–ª—É—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ 10 –∫—Ä–µ–¥–∏—Ç–æ–≤</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.js';

// ---------------------------
// ‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase
// ---------------------------
const SUPABASE_URL = "–í–ê–®_SUPABASE_URL"; // –∏–∑ Secrets
const SUPABASE_ANON_KEY = "–í–ê–®_ANON_KEY"; // –∏–∑ Secrets (–ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á)
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------------------------
// ‚ö° Telegram Mini App
// ---------------------------
const tg = window.Telegram.WebApp;
tg.ready();

// ---------------------------
// ‚ö° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// ---------------------------
let userId;
async function initUser() {
  const user = tg.initDataUnsafe?.user;
  if (!user || !user.id) {
    console.log("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram");
    return;
  }
  userId = user.id;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ç–∞–±–ª–∏—Ü–µ
  const { data: existingUser, error } = await supabase
    .from("users")
    .select("*")
    .eq("id", userId)
    .maybeSingle();

  if (error) console.log("–û—à–∏–±–∫–∞ select:", error);

  if (!existingUser) {
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º
    const { error: insertError } = await supabase
      .from("users")
      .insert({ id: userId, credits: 0 });

    if (insertError) console.log("–û—à–∏–±–∫–∞ insert:", insertError);

    updateCreditsUI(0);
  } else {
    updateCreditsUI(existingUser.credits);
  }
}

// ---------------------------
// ‚ö° –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
// ---------------------------
function updateCreditsUI(value) {
  document.getElementById("credits").innerText = value;
}

// ---------------------------
// ‚ö° –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ (–¥–ª—è —Ç–µ—Å—Ç–∞)
// ---------------------------
async function addCredits(amount) {
  if (!userId) return;

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫—Ä–µ–¥–∏—Ç—ã
  const { data: userData, error: selectError } = await supabase
    .from("users")
    .select("credits")
    .eq("id", userId)
    .maybeSingle();

  if (selectError) { console.log("Select error:", selectError); return; }

  const newCredits = (userData?.credits || 0) + amount;

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
  const { error: updateError } = await supabase
    .from("users")
    .update({ credits: newCredits })
    .eq("id", userId);

  if (updateError) { console.log("Update error:", updateError); return; }

  updateCreditsUI(newCredits);
}

// ---------------------------
// ‚ö° –ó–∞–ø—É—Å–∫
// ---------------------------
initUser();

</script>

</body>
</html>
