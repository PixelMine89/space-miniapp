<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Space Fleet</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body { background:#0b1020; color:white; font-family:Arial; text-align:center }
.card { background:#151b35; margin:15px; padding:15px; border-radius:12px }
button { padding:10px 20px; margin:5px; font-size:16px }
</style>
</head>
<body>

<h2>üöÄ Space Fleet</h2>

<div class="card">
  <b>–ö—É–ø–∏—Ç—å —Ä–∞–∫–µ—Ç—É</b><br>
  <button onclick="buyRocket('Scout')">Scout (10‚≠ê)</button>
  <button onclick="buyRocket('Cargo')">Cargo (25‚≠ê)</button>
  <button onclick="buyRocket('Fighter')">Fighter (50‚≠ê)</button>
  <button onclick="buyRocket('Explorer')">Explorer (100‚≠ê)</button>
</div>

<div class="card">
  <b>–ú–æ–∏ —Ä–∞–∫–µ—Ç—ã</b>
  <div id="myRockets">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();

const API = "https://script.google.com/macros/s/XXXX/exec";
const userId = tg.initDataUnsafe.user.id;

fetch(API, {
  method: "POST",
  body: JSON.stringify({ action: "register", user_id: userId })
});

loadRockets();

function buyRocket(type) {
  alert("buyRocket clicked: " + type);

  tg.MainButton.offClick(); // ‚ùó –û–ß–ò–©–ê–ï–ú –°–¢–ê–†–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò

  tg.MainButton.setText("–ö—É–ø–∏—Ç—å " + type);
  tg.MainButton.show();

  tg.MainButton.onClick(() => {
    alert("MainButton clicked");

tg.sendData(JSON.stringify({
  action: "buy_rocket",
  type: type
}));

tg.close(); // ‚¨Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —á–∞—Ç
  });
}

function loadRockets() {
  console.log("loadRockets() start", userId);

  fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "getRockets",
      user_id: userId
    })
  })
  .then(r => {
    console.log("API status", r.status);
    return r.text();
  })
  .then(text => {
    console.log("API raw response:", text);

    let list;
    try {
      list = JSON.parse(text);
    } catch (e) {
      document.getElementById("myRockets").innerText =
        "‚ùå –û—à–∏–±–∫–∞ JSON (—Å–º. –∫–æ–Ω—Å–æ–ª—å)";
      return;
    }

    if (!Array.isArray(list) || list.length === 0) {
      document.getElementById("myRockets").innerText = "–ù–µ—Ç —Ä–∞–∫–µ—Ç";
      return;
    }

    document.getElementById("myRockets").innerHTML =
      list.map(r => "üöÄ " + r.type).join("<br>");
  })
  .catch(err => {
    console.error("loadRockets error", err);
    document.getElementById("myRockets").innerText =
      "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
  });
}
</script>

</body>
</html>

