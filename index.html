<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Space Fleet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; font-family: Arial,sans-serif; background:#0b1020; color:#fff; text-align:center; }
    h1 { margin-top:20px; }
    .card { background:#151b35; margin:15px; padding:15px; border-radius:12px; }
    button { background:#4da3ff; border:none; padding:12px 20px; border-radius:10px; font-size:16px; cursor:pointer; margin-top:10px; }
    #rocketsList { text-align:left; max-width:400px; margin:auto; }
  </style>
</head>
<body>

<h1>üöÄ Space Fleet</h1>

<div class="card">
  <p><b>Credits:</b> <span id="credits">0</span></p>
  <p><b>Stars:</b> <span id="stars">0</span></p>
</div>

<div class="card">
  <p><b>–ö—É–ø–∏—Ç—å ‚≠ê</b></p>
  <button onclick="buyStars(10)">10 ‚≠ê</button>
  <button onclick="buyStars(25)">25 ‚≠ê</button>
  <button onclick="buyStars(50)">50 ‚≠ê</button>
  <button onclick="buyStars(100)">100 ‚≠ê</button>
</div>

<div class="card">
  <p><b>–ö—É–ø–∏—Ç—å —Ä–∞–∫–µ—Ç—É –∑–∞ ‚≠ê:</b></p>
  <button onclick="buyRocket('Scout')">Scout (10‚≠ê)</button>
  <button onclick="buyRocket('Cargo')">Cargo (25‚≠ê)</button>
  <button onclick="buyRocket('Fighter')">Fighter (50‚≠ê)</button>
  <button onclick="buyRocket('Explorer')">Explorer (100‚≠ê)</button>
</div>

<div class="card">
  <p><b>–†–∞–∫–µ—Ç—ã:</b></p>
  <div id="rocketsList">–°–ø–∏—Å–æ–∫ —Ä–∞–∫–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏</div>
  <button onclick="collectCredits()">–°–æ–±—Ä–∞—Ç—å credits</button>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();

  // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL Google Apps Script
  const API_URL = "https://script.google.com/macros/s/AKfycbx15P57litpasgzQAGqSAy46c84V_EmKVOhGcMPHfRBbzx-qGh2nGxt9jBeZ5Xm08uU/exec"; 
  const userId = tg.initDataUnsafe.user.id;

  // ======== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ========
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({action: "registerUser", user_id: userId})
  }).then(r => r.json()).then(data => {
    console.log("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:", data);
    getUserData();
    getRockets();
  });

  // ======== –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ========
  function getUserData() {
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({action: "getUser", user_id: userId})
    })
    .then(r => r.json())
    .then(data => {
      console.log("User data:", data);
      if(data.credits !== undefined) document.getElementById("credits").innerText = data.credits;
      if(data.stars !== undefined) document.getElementById("stars").innerText = data.stars;
    });
  }

  function buyStars(amount) {
  Telegram.WebApp.openInvoice({
    title: "–ü–æ–∫—É–ø–∫–∞ –∑–≤–µ–∑–¥",
    description: amount + " ‚≠ê –¥–ª—è Space Fleet",
    payload: "stars_" + amount,
    currency: "XTR",
    prices: [{ label: amount + " ‚≠ê", amount: amount }]
  });
  }

  Telegram.WebApp.onEvent("invoiceClosed", function (event) {
  if (event.status === "paid") {
    const payload = event.payload; // stars_50
    const amount = parseInt(payload.split("_")[1]);
    addStarsToUser(amount);
  }
  });

  function addStarsToUser(amount) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "addStars",
      user_id: userId,
      amount: amount
    })
  })
  .then(r => r.json())
  .then(data => {
    alert("–ó–≤—ë–∑–¥—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã: " + amount);
    getUserData();
  });
  }

  // ======== –ü–æ–∫—É–ø–∫–∞ —Ä–∞–∫–µ—Ç—ã ========
  function buyRocket(type) {
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({action: "buyRocket", user_id: userId, rocket_type: type})
    })
    .then(r => r.json())
    .then(data => {
      if(data.status === "ok"){
        alert("–†–∞–∫–µ—Ç–∞ –∫—É–ø–ª–µ–Ω–∞!");
        getUserData();
        getRockets();
      } else {
        alert("–û—à–∏–±–∫–∞: " + (data.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
      }
    });
  }

  // ======== –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–∫–µ—Ç ========
  function getRockets() {
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({action: "getRockets", user_id: userId})
    })
    .then(r => r.json())
    .then(data => {
      const listDiv = document.getElementById("rocketsList");
      if(data.length === 0){
        listDiv.innerHTML = "–†–∞–∫–µ—Ç –Ω–µ—Ç";
        return;
      }
      let html = "<ul>";
      data.forEach(r => {
        const bought = new Date(r.bought_at);
        html += <li>${r.rocket_type} | Fuel: ${r.fuel} | Health: ${r.health} | Bought: ${bought.toLocaleString()} | Duration: ${r.duration}h | Reward: ${r.reward}</li>;
      });
      html += "</ul>";
      listDiv.innerHTML = html;
    });
  }

  // ======== –°–æ–±—Ä–∞—Ç—å credits ========
  function collectCredits() {
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({action: "collectCredits", user_id: userId})
    })
    .then(r => r.json())
    .then(data => {
      if(data.status === "ok"){
        alert("Credits –Ω–∞—á–∏—Å–ª–µ–Ω—ã: " + data.credits);
        getUserData();
        getRockets();
      } else {
        alert("–û—à–∏–±–∫–∞: " + (data.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
      }
    });
  }

</script>

</body>
</html>

